# Section 2: ETL with DBT and Liquibase
## Summary
### Task 1: ETL Pipeline with DBT
Create a DBT project to transform the cleaned Airbnb data into a model that provides
monthly booking counts per neighborhood.
#### Deliverables:
1. DBT models and associated SQL files.
2. Documentation generated by DBT for the models.
### Task 2: Database Versioning with Liquibase
Develop a Liquibase changelog to:
1. Add a new column last_review_date to the Listings table.
2. Create a new table Amenities with fields amenity_id, listing_id, and amenity_name.
#### Deliverables:
1. Liquibase changelog XML file.
2. Rollback scripts for each change.
# Section 3: Docker, Git, and CI/CD (1 Hour)
## Summary
### Task 1: Dockerize the DBT Project
Write a Dockerfile to containerize the DBT project, ensuring it can run independently with all dependencies.
#### Deliverables:
1. Dockerfile and any associated configuration files.
### Task 2: Git and CI/CD Pipeline
Initialize a Git repository and:
1. Commit all project files with clear commit messages.
2. Set up a CI/CD pipeline (using tools like GitHub Actions) to automate DBT model tests and data quality checks on each push to the repository.
#### Deliverables:
1. Link to the Git repository.
2. CI/CD pipeline configuration file (e.g., YAML).

## Solution
### Section 2 Task 1: ETL Pipeline with DBT
Dbt project has been configured with multiples models. Also the profiles.yml has been added to be able to run it with docker-compose. 

The profiles.yml has 3 diferent env, [gold,silver,bronze], so we can have different schemas or databases for each env. With that we were able to create a medalion architecture inside dbt.

To be able to move between schemas, the ref_silver macro was created to be able to call the models from gold to silver. For silver, it is able to read data from bronze with the source.yml file.

The schema.yml file that is at each of the layers of the models, was added to have metadata and test for the models that are being created. With that file we are able to run the `dbt test` and the `dbt docs generate`.
#### How to run the dbt project?
Dbt project has been added into a docker conteiner. To be able to run it, we need to use docker compose do start up the whole env.
```bash
docker-compose up -d
```
### Section 2 Task 2: Database Versioning with Liquibase
Some of the files that I got the chance to use at my research, can be found at the liquibase_files/ directory. 

The liquibase proccess was successfully added into the docker-compose file that is in the main directory. It means, /section2_3/docker-compose.yml, the process that is being exeucted is the `generate-changelog`, that is going to fetch all the changes and object at the database and is going to generate an xml file with all that metadata.

#### How to run the liquibase?
```bash
docker-compose up -d
```

Scripts to update, tag and rollback the database can be found at the /section2_3/scripts/ directory. There are some docker-compose files that are pointing to the same image that was created at the main directory.

Also the liquibase_scripts.py was created to be able to run the scripts without requiring to run docker-compose manually. The scripts is able to run the docker-compose up and down.

#### How to run the scripts?
```bash
python3 liquibase_scripts.py --execute=tag
python3 liquibase_scripts.py --execute=update
python3 liquibase_scripts.py --execute=rollback
```

#### How to run the liquibase docker-compose files manually?
```bash
docker-compose -f docker-compose.liquibase.tag.yml up
docker-compose -f docker-compose.liquibase.update.yml up
docker-compose -f docker-compose.liquibase.rollback.yml up
```

### Section 3 Task 1: Dockerize the DBT Project
The docker file can be found at dbt_leantech_airbnb_project/, we had to set and entrypoint to be able to run the dbt project with a python script, since while we were building the docker file we didn't got a chance run the dbt models at the creation of the conteiner.

Also the dbt image that we are fetching and pulling from docker hub, is using a sha256 sing, we got the issue with docker since it was requesting us for a sign to pull the image.

The dbt project is also at the docker-compose file that is located at the main folder for this section.

### Section 3 Task 2: Git and CI/CD Pipeline

## Project layout

    ├─ data/               
    │  └─ liquibase/changelog/          xml files for liquibase changes can be found here.
    ├─ dbt_docs/                        dbt docs generate result can be found here.
    ├─ dbt_leantech_airbnb_project/     Whole dbt project is going to be here.
    │  └─ models/                       dbt models can be found here.
    ├─ liquibase_files/                 Part of the development and testing for the liquibase research.   
    ├─ scripts/                         python scripts to run the liquibase update, tag and rollback can be found here.
    └─ sql/                             sql script done to update the database with liquibase.

## Referenes
* https://github.com/dbt-labs/dbt-core/pkgs/container/dbt-postgres
* https://docs.getdbt.com/docs/core/pip-install
* https://docs.liquibase.com/change-types/enddelimiter-sql.html#xml_example
* https://docs.liquibase.com/commands/update/update.html
* https://docs.liquibase.com/commands/utility/tag.html
* https://docs.liquibase.com/commands/rollback/rollback.html
* https://docs.liquibase.com/workflows/liquibase-community/using-liquibase-and-docker.html
* https://docs.liquibase.com/start/tutorials/postgresql/postgresql.html
* https://docs.docker.com/compose/install/
* https://forum.liquibase.org/t/add-liquibase-with-docker-compose/6891
* https://docs.liquibase.com/concepts/connections/creating-config-properties.html
* https://github.com/ergulcu/poc-liquibase-docker/blob/master/docker-compose.liquibase.update.yml
* https://hub.docker.com/r/liquibase/liquibase
* https://docs.liquibase.com/commands/init/project.html
* https://docs.liquibase.com/commands/inspection/generate-changelog.html
* https://docs.liquibase.com/workflows/liquibase-community/using-jdbc-url-in-liquibase.html
* https://docs.liquibase.com/start/tutorials/postgresql/postgresql.html#xml_example
* https://docs.liquibase.com/workflows/liquibase-community/diffing-multiple-schemas-in-liquibase.html